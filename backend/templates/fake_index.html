<!-- Author ChatGPT-4, Prompter the humble Solesschong -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/9.5.6/jsoneditor.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/9.5.6/jsoneditor.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>
        
    <style>
        .task-panel {
            margin-bottom: 1rem;
        }

        .task-img {
            max-width: 100%;
            height: auto;
        }
        .scene-container {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        .scene-img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin-right: 10px;
        }
        .task-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            margin-right: 5px;
        }
    </style>
</head>

<body>
    <!-- Tabs -->
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab"
                aria-controls="dashboard" aria-selected="false">Dashboard</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="scenes-tab" data-bs-toggle="tab" href="#scenes" role="tab"
                aria-controls="scenes" aria-selected="false">Scenes</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="taskViewer-tab" data-bs-toggle="tab" href="#taskViewer" role="tab"
                aria-controls="taskViewer" aria-selected="false">Task Viewer</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="createTask-tab" data-bs-toggle="tab" href="#createTask" role="tab"
                aria-controls="createTask" aria-selected="false">Create Task</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="createPerson-tab" data-bs-toggle="tab" href="#createPerson" role="tab"
                aria-controls="createPerson" aria-selected="true">Create Person</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="scene-edit-tab" data-bs-toggle="tab" href="#scene-edit" role="tab"
                aria-controls="scene-edit" aria-selected="false">Scene Edit</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="person-tab" data-bs-toggle="tab" href="#person" role="tab"
                aria-controls="person" aria-selected="false">Person</a>
        </li>
    </ul>
    <div class="tab-content" id="mainTabsContent">
        <div class="tab-pane fade" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
            <!-- Dashboard content -->
            <div class="container">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                Task Stats
                            </div>
                            <div class="card-body" id="task-stats">
                                <!-- Task stats will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                Scene Stats
                            </div>
                            <div class="card-body" id="scene-stats">
                                <!-- Scene stats will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="createPerson" role="tabpanel" aria-labelledby="createPerson-tab">
            <!-- Create Person content -->
        </div>
        <div class="tab-pane fade" id="scenes" role="tabpanel" aria-labelledby="scenes-tab">
            <!-- Scenes content -->
        </div>
        <div class="tab-pane fade show active" id="taskViewer" role="tabpanel" aria-labelledby="taskViewer-tab">
            <!-- Filter section -->
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <label class="input-group-text" for="collection-name-filter">Collection:</label>
                        <select class="form-select" id="collection-name-filter">
                            <option value="">All Collections</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <label class="input-group-text" for="person-id-filter">Person:</label>
                        <select class="form-select" id="person-id-filter">
                            <option value="">All Persons</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary" id="apply-filters-btn">Apply Filters</button>
                </div>
            </div>
        
            <!-- Task Viewer content -->
            <div class="row task-container mt-4" id="task-container">
                <!-- Task viewer panels will be added here -->
            </div>
            <div class="d-grid mt-3">
                <button id="load-more-btn" class="btn btn-primary">Load More</button>
            </div>
        </div>
        
        <div class="tab-pane fade" id="createTask" role="tabpanel" aria-labelledby="createTask-tab">
            <!-- Create Task content -->
            <div class="row" id="create-task-container">
                <select id="collection-select">
                    <!-- Collections options will be populated here -->
                </select>
                <select id="person-select">
                    <!-- Persons options will be populated here -->
                </select>
            </div>
            <button id="generate-tasks">Generate Tasks</button>
        </div>
        <div class="tab-pane fade" id="scene-edit" role="tabpanel" aria-labelledby="scene-edit-tab">
            <!-- Scene edit content -->
            <div class="container">
                <div class="row mt-4">
                    <div class="col">
                        <label for="collection-name-filter">Filter by Collection Name:</label>
                        <input type="text" id="collection-name-filter" placeholder="Enter collection name">
                        <button class="btn btn-primary" onclick="applyFilter()">Apply Filter</button>
                        <select id="collection-name-dropdown" onchange="selectFilterFromDropdown()">
                            <option value="">Select a collection</option>
                        </select>
                    </div>
                </div>
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        populateCollectionDropdown();
                    });
                </script>
                <div id="scene-edit-data">
                    <!-- Add the scene edit HTML structure here -->
                </div>
                <div id="scene-pagination" class="text-center mt-4">
                    <nav aria-label="Scene pagination">
                        <ul class="pagination">
                            <li class="page-item">
                                <a class="page-link" href="#" aria-label="Previous" onclick="changeScenePage(-1)">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#" id="scene-current-page">1</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#" aria-label="Next" onclick="changeScenePage(1)">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
            <button id="load-more-scenes" class="btn btn-primary" onclick="loadMoreScenes()">Load More</button>
        </div>
        <div class="tab-pane fade" id="person" role="tabpanel" aria-labelledby="person-tab">
            <!-- Person content -->
            <div class="container" id="person-container">
                <!-- Person cards will be populated here -->
            </div>
        </div>
        
    </div>

    <script>
        ////////////////////////////
        // Stats Tab
        function fetchStats() {
            fetch('/get_task_stats')
                .then(response => response.json())
                .then(taskStats => {
                    displayTaskStats(taskStats);
                })
                .catch(error => {
                    console.error('Error fetching task stats:', error);
                });

            fetch('/get_scene_stats')
                .then(response => response.json())
                .then(sceneStats => {
                    displaySceneStats(sceneStats);
                })
                .catch(error => {
                    console.error('Error fetching scene stats:', error);
                });
        }

        function displayTaskStats(taskStats) {
            const taskStatsElem = document.getElementById('task-stats');
            taskStatsElem.innerHTML = `
                <p>Wait: ${taskStats.wait}</p>
                <p>Finish: ${taskStats.finish}</p>
                <p>Fail: ${taskStats.fail}</p>
            `;
        }

        function displaySceneStats(sceneStats) {
            const sceneStatsElem = document.getElementById('scene-stats');
            sceneStatsElem.innerHTML = `
                <p>Wait: ${sceneStats.wait}</p>
                <p>Finish: ${sceneStats.finish}</p>
                <p>Fail: ${sceneStats.fail}</p>
            `;
        }

        // Fetch stats when the dashboard tab is shown
        document.getElementById('dashboard-tab').addEventListener('shown.bs.tab', function (e) {
            fetchStats();
        });

        ////////////////////////////////////////////////
        // Add task tab

        let currentPage = 1;
        let totalPages = 1;

        function addTaskPanel(task) {
            const taskContainer = document.getElementById('task-container');

            const column = document.createElement('div');
            column.className = 'col-12 col-md-6 col-lg-4';

            const panel = document.createElement('div');
            panel.className = 'card task-panel';

            const img = document.createElement('img');
            const originalImgSrc = 'https://photolab-test.oss-cn-shenzhen.aliyuncs.com/' + task.result_img_key;
            const croppedImgSrc = originalImgSrc + '?x-oss-process=image/resize,w_400';
            img.src = croppedImgSrc;
            img.classList.add('card-img-top');

            // Add the Fancybox functionality
            const lightboxLink = document.createElement('a');
            lightboxLink.href = originalImgSrc;
            lightboxLink.setAttribute('data-fancybox', 'gallery');
            lightboxLink.appendChild(img);
            panel.appendChild(lightboxLink);

            const info = document.createElement('div');
            info.className = 'card-body';
            info.innerHTML = '<h5 class="card-title">Task ID: ' + task.id +
                '</h5><p class="card-text">Person IDs: ' + task.person_id_list.join(', ') +
                '</p>' + '<p class="card-text">Scene ID: ' + task.scene_id + '</p>';
            panel.appendChild(info);

            column.appendChild(panel);
            taskContainer.appendChild(column);
        }


        function fetchTasks(page) {
            fetch(`/get_tasks?page=${page}`)
            .then((response) => response.json())
            .then((data) => {
                const tasks = data.tasks;
                totalPages = data.total_pages;

                const taskContainer = document.getElementById('task-container');
                taskContainer.innerHTML = '';

                tasks.forEach(addTaskPanel);

                if (currentPage === totalPages) {
                    const loadMoreBtn = document.getElementById('load-more-btn');
                    loadMoreBtn.disabled = true;
                    loadMoreBtn.textContent = 'No More Tasks';
                }
            })
            .catch((error) => {
                console.error('Error fetching tasks:', error);
            });
        }

        function loadTasks(page) {
            const collection_name_filter = document.getElementById('collection-name-filter').value;
            const person_id_filter = document.getElementById('person-id-filter').value;

            let url = `/get_tasks?page=${page}`;
            if (collection_name_filter) url += `&collection_name=${encodeURIComponent(collection_name_filter)}`;
            if (person_id_filter) url += `&person_id=${encodeURIComponent(person_id_filter)}`;

            fetch(url)
                .then((response) => response.json())
                .then((data) => {
                    const taskContainer = document.getElementById('task-container');
                    taskContainer.innerHTML = '';

                    const tasks = data.tasks;
                    totalPages = data.total_pages;

                    if (tasks.length === 0) {
                        // Display an empty message when there are no tasks
                        const emptyMessageContainer = document.createElement('div');
                        emptyMessageContainer.className = 'col-12 text-center my-5';

                        const emptyMessage = document.createElement('h3');
                        emptyMessage.className = 'text-muted';
                        emptyMessage.textContent = 'Empty';

                        emptyMessageContainer.appendChild(emptyMessage);
                        taskContainer.appendChild(emptyMessageContainer);
                    } else {
                        tasks.forEach(addTaskPanel);
                    }

                    if (currentPage === totalPages) {
                        const loadMoreBtn = document.getElementById('load-more-btn');
                        loadMoreBtn.disabled = true;
                        loadMoreBtn.textContent = 'No More Tasks';
                    }
                })
                .catch((error) => {
                    console.error('Error fetching tasks:', error);
                });
        }


        function fetchCollections() {
            fetch('/get_collections')
            .then(response => response.json())
            .then(collections => {
                const collectionFilter = document.getElementById('collection-name-filter');
                collections.forEach(collection => {
                    const option = document.createElement('option');
                    option.value = collection;
                    option.textContent = collection;
                    collectionFilter.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching collections:', error));
        }

        function fetchPersons() {
            fetch('/get_persons')
            .then(response => response.json())
            .then(persons => {
                const personFilter = document.getElementById('person-id-filter');
                persons.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person.id;
                    option.textContent = `[${person.id}] - ${person.name}`;
                    personFilter.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching persons:', error));
        }

        fetchCollections();
        fetchPersons();

        // Add this function to handle the apply filters button click event
        function applyFilters() {
            const collectionFilter = document.getElementById('collection-name-filter');
            const personFilter = document.getElementById('person-id-filter');

            // Reset the currentPage and call loadTasks with new filters
            currentPage = 1;
            loadTasks(currentPage);
        }

        // Attach the click event to the "Apply Filters" button
        document.getElementById('apply-filters-btn').addEventListener('click', applyFilters);

        // Initialize Task Viewer
        // fetchTasks(currentPage);

        ////////////////////////////////////////////////
        // TaskView Tab

        document.addEventListener('DOMContentLoaded', () => {
            loadTasks(currentPage);
            const loadMoreBtn = document.getElementById('load-more-btn');
            loadMoreBtn.addEventListener('click', () => {
                currentPage += 1;
                loadTasks(currentPage);
            });
        });

        // Populate collection and person dropdowns
        function loadCollectionsAndPersons() {
            fetch('/get_collections')
                .then(response => response.json())
                .then(collections => {
                    const select = document.getElementById('collection-select');
                    collections.forEach(collection => {
                        const option = document.createElement('option');
                        option.value = collection;
                        option.textContent = collection;
                        select.appendChild(option);
                    });
                });

            fetch('/get_persons')
                .then(response => response.json())
                .then(persons => {
                    const select = document.getElementById('person-select');
                    persons.forEach(person => {
                        const option = document.createElement('option');
                        option.value = person.id;
                        option.textContent = `[${person.id}] - ${person.name}`;
                        select.appendChild(option);
                    });
                });
        }

        ////////////////////////////////////////////////
        // Scene tab
        function updateSceneRate(sceneId, action) {
            fetch('/update_scene_rate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    scene_id: sceneId,
                    action: action
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update rate value in the DOM
                    const rateElem = document.querySelector(`.scene-info[data-scene-id="${sceneId}"] .rate-value`);
                    if (rateElem) {
                        rateElem.textContent = data.rate;
                    }
                } else {
                    console.error("Error updating rate:", data.error);
                }
            })
            .catch((error) => console.error("Error:", error));
        }

        // Helper functions
        function createImageElement(src, className) {
            const img = document.createElement('img');
            img.src = src;
            img.classList.add(className);
            return img;
        }

        function populateCollectionDropdown() {
            fetch('/get_collections')
                .then(response => response.json())
                .then(collections => {
                    const dropdown = document.getElementById('collection-name-dropdown');
                    collections.forEach(collection => {
                        const option = document.createElement('option');
                        option.value = collection;
                        option.text = collection;
                        dropdown.add(option);
                    });
                })
                .catch(error => console.error('Error fetching collections:', error));
        }

        function selectFilterFromDropdown() {
            const dropdown = document.getElementById('collection-name-dropdown');
            const collection_name_filter = dropdown.value;
            document.getElementById('collection-name-filter').value = collection_name_filter;
            applyFilter();
        }
        let currentCollectionFilter = '';

        function applyFilter() {
            const collection_name_filter = document.getElementById('collection-name-filter').value;
            currentCollectionFilter = collection_name_filter;
            loadSceneEditData(1, collection_name_filter);
        }

        function updateSceneParams(scene_id) {
            const paramsTextarea = document.getElementById(`params-${scene_id}`);
            const updated_params = paramsTextarea.value;

            fetch(`/api/scene/${scene_id}/update_params`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ params: updated_params })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log("Params updated successfully.");
                    } else {
                        console.error("Error updating params:", data.error);
                    }
                })
                .catch(error => console.error("Error updating params:", error));
        }

        function updateScenePrompt(scene_id) {
            const prompt = document.getElementById(`prompt-${scene_id}`).value;
            fetch(`/api/scene/${scene_id}/update_prompt`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `prompt=${encodeURIComponent(prompt)}`
            })
            .then(response => response.json())
            .then(json => {
                if (json.success) {
                    alert('Prompt updated successfully.');
                } else {
                    alert('Failed to update prompt: ' + json.error);
                }
            });
        }

        document.getElementById('scene-edit-tab').addEventListener('shown.bs.tab', loadSceneEditData);

        let currentScenePage = 1;

        function loadSceneEditData(page, collection_name_filter='') {
            // Fetch the scenes
            const url = `/list_scenes?page=${page}&collection_name_filter=${encodeURIComponent(collection_name_filter)}`; 
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const scenes = data.scenes;
                    const total_pages = data.total_pages;
                    const container = document.querySelector('#scene-edit-data');
                    container.innerHTML = '';

                    scenes.forEach(scene => {
                        // Create scene row
                        const sceneRow = document.createElement('div');
                        sceneRow.className = 'row scene-row';
                        container.appendChild(sceneRow);

                        // Add base_img
                        const baseImgCol = document.createElement('div');
                        baseImgCol.className = 'col-2';
                        const baseImg = document.createElement('img');
                        baseImg.src = `https://photolab-test.oss-cn-shenzhen.aliyuncs.com/${scene.base_img_key}`;
                        baseImg.className = 'img-thumbnail';
                        baseImgCol.appendChild(baseImg);
                        sceneRow.appendChild(baseImgCol);

                        // Add hint_img if exists
                        if (scene.hint_img_list && scene.hint_img_list.length > 0) {
                            const hintImgCol = document.createElement('div');
                            hintImgCol.className = 'col-2';
                            const hintImg = document.createElement('img');
                            hintImg.src = `https://photolab-test.oss-cn-shenzhen.aliyuncs.com/${scene.hint_img_list[0]}`;
                            hintImg.className = 'img-thumbnail';
                            hintImgCol.appendChild(hintImg);
                            sceneRow.appendChild(hintImgCol);
                        }

                        // Fetch tasks for this scene
                        fetch(`/list_tasks/${scene.scene_id}`)
                            .then(response => response.json())
                            .then(tasks => {
                                const tasksCol = document.createElement('div');
                                tasksCol.className = 'col';
                                sceneRow.appendChild(tasksCol);
                                tasks.forEach(task => {
                                    const taskImgLink = document.createElement('a');
                                    taskImgLink.href = task.result_img_key;
                                    taskImgLink.setAttribute('data-fancybox', `gallery-${scene.scene_id}`);
                                    tasksCol.appendChild(taskImgLink);

                                    const taskImg = document.createElement('img');
                                    taskImg.src = task.result_img_key;
                                    taskImg.className = 'task-img';
                                    taskImgLink.appendChild(taskImg);
                                });
                            });

                        // Add additional scene info and editable fields
                        const sceneInfo = document.createElement('div');
                        sceneInfo.innerHTML = `
                            <p><strong>Scene ID:</strong> ${scene.scene_id}</p>
                            <p><strong>Collection Name:</strong> ${scene.collection_name}</p>
                            <p><strong>Prompt:</strong></p>
                            <textarea id="prompt-${scene.scene_id}" rows="4" style="width: 100%;">${scene.prompt}</textarea>
                            <button onclick="updateScenePrompt(${scene.scene_id});">Save Prompt</button>
                            <p><strong>Params:</strong></p>
                            <textarea id="params-${scene.scene_id}" rows="4" style="width: 100%;">${JSON.stringify(scene.params, null, 2)}</textarea>
                            <button onclick="updateSceneParams(${scene.scene_id});">Save Params</button>
                            <p><strong>Rate:</strong> ${scene.rate}</p>
                            <button onclick="updateSceneRate(${scene.scene_id}, 'add');">Add</button>
                            <button onclick="updateSceneRate(${scene.scene_id}, 'minus');">Minus</button>
                        `;
                        sceneRow.appendChild(sceneInfo);
                    });
                    // If there are no more scenes to load, hide the "Load More" button
                    if (currentScenePage >= total_pages) {
                        document.getElementById('load-more-scenes').style.display = 'none';
                    }
                })
                .catch(error => console.error('Error fetching scenes:', error));
        }

        function loadMoreScenes() {
            currentScenePage += 1;
            loadSceneEditData(currentPage, currentCollectionFilter);
        }


        ////////////////////////////////////////////////
        // Create Task Tab
        document.addEventListener('DOMContentLoaded', loadCollectionsAndPersons);

        // Generate tasks
        document.getElementById('generate-tasks').addEventListener('click', function () {
            const collectionName = document.getElementById('collection-select').value;
            const personId = document.getElementById('person-select').value;
            fetch('/generate_tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ collection_name: collectionName, person_id: personId })
            });
        });

        ////////////////////////////////////////////////
        // Person Tab
        async function getGeoLocation(ip, apiKey) {
            const response = await fetch(`https://ipapi.co/${ip}/json`);
            const data = await response.json();
            return data;
        }

        async function loadPersonData() {
            // Fetch the persons
            try {
                const response = await fetch('/list_persons');
                const persons = await response.json();

                const container = document.querySelector('#person-container');
                container.innerHTML = '';

                for (const person of persons) {
                    // Fetch geo location
                    const geoData = await getGeoLocation(person.ip, 'your_api_key_here');
                    const location = `${geoData.city}, ${geoData.region}, ${geoData.country_name}`;

                    // Create person card
                    const personCard = document.createElement('div');
                    personCard.className = 'card mb-3';
                    container.appendChild(personCard);

                    // Create person card body
                    const cardBody = document.createElement('div');
                    cardBody.className = 'card-body';
                    personCard.appendChild(cardBody);

                    // Create a row for person info
                    const infoRow = document.createElement('div');
                    infoRow.className = 'row';
                    cardBody.appendChild(infoRow);

                    // Add person ID
                    const personId = document.createElement('div');
                    personId.className = 'col-md-4 mb-2';
                    personId.innerHTML = `<h5 class="card-title mb-0">ID: ${person.id}</h5>`;
                    infoRow.appendChild(personId);

                    // Add person name
                    const personName = document.createElement('div');
                    personName.className = 'col-md-4 mb-2';
                    personName.innerHTML = `<h5 class="card-title mb-0">Name: ${person.name}</h5>`;
                    infoRow.appendChild(personName);

                    // Add person lora_train_status
                    const personLoraTrainStatus = document.createElement('div');
                    personLoraTrainStatus.className = 'col-md-4 mb-2';
                    personLoraTrainStatus.innerHTML = `<h5 class="card-title mb-0">Lora Train Status: ${person.lora_train_status}</h5>`;
                    infoRow.appendChild(personLoraTrainStatus);

                    // Add person dataset quality
                    const personDatasetQuality = document.createElement('div');
                    personDatasetQuality.className = 'col-12 mb-2';
                    // Stringify the JSON object
                    const datasetQualityStr = JSON.stringify(person.dataset_quality, null, 2);
                    personDatasetQuality.innerHTML = `<pre class="card-text mb-0">Dataset Quality: ${datasetQualityStr}</pre>`;
                    infoRow.appendChild(personDatasetQuality);

                    // Add person user ID
                    const personUserId = document.createElement('div');
                    personUserId.className = 'col-md-4 mb-2';
                    personUserId.innerHTML = `<h5 class="card-title mb-0">User ID: ${person.user_id}</h5>`;
                    infoRow.appendChild(personUserId);

                    // Add person IP and location
                    const personIpLocation = document.createElement('div');
                    personIpLocation.className = 'col-12 mb-2';
                    personIpLocation.innerHTML = `<p class="card-text mb-0">IP: ${person.ip}, Location: ${location}</p>`;
                    infoRow.appendChild(personIpLocation);

                    // Add person photos container
                    const photosContainer = document.createElement('div');
                    photosContainer.className = 'd-flex flex-row flex-wrap';
                    cardBody.appendChild(photosContainer);

                    // Fetch photos for this person
                    const sourcesResponse = await fetch(`/list_sources?person_id=${person.id}`);
                    const sources = await sourcesResponse.json();

                    sources.forEach(source => {
                        const photo = document.createElement('img');
                        const photoSrc = `https://photolab-test.oss-cn-shenzhen.aliyuncs.com/${source.base_img_key}`;

                        // Add FancyBox functionality
                        const lightboxLink = document.createElement('a');
                        lightboxLink.href = photoSrc;
                        lightboxLink.setAttribute('data-fancybox', `gallery-${person.id}`);
                        photosContainer.appendChild(lightboxLink);

                        // Configure the thumbnail image
                        photo.src = `${photoSrc}?x-oss-process=image/resize,w_150`;
                        photo.className = 'img-thumbnail me-2 mb-2';
                        lightboxLink.appendChild(photo);
                    });
                }
            } catch (error) {
                console.error('Error fetching persons:', error);
            }
        }


        // Load person data when the Person tab is clicked
        document.getElementById('person-tab').addEventListener('click', loadPersonData);

    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.min.js"
        crossorigin="anonymous"></script>
</body>
</html>
    